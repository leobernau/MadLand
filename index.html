<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Monster Survival Game</title>
<style>
body{margin:0;overflow:hidden;background:#111;font-family:sans-serif;}
canvas{display:block;margin:0 auto;background:#222;}
#ui{position:absolute;top:10px;width:100%;text-align:center;color:white;font-size:32px;font-weight:bold;}
#upgradeMenu{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;flex-direction:column;color:white;font-size:24px;display:none;}
#upgradeMenu button{margin:10px;padding:10px 20px;background:#555;color:white;border:none;border-radius:5px;cursor:pointer;font-size:18px;}
#deathMenu{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:flex;justify-content:center;align-items:center;flex-direction:column;color:red;font-size:32px;display:none;}
#deathMenu button{margin:10px;padding:10px 20px;background:#555;color:white;border:none;border-radius:5px;cursor:pointer;font-size:20px;}
</style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="600"></canvas>
<div id="ui">45:00</div>
<div id="upgradeMenu"></div>
<div id="deathMenu">
  <div>Du bist gestorben!</div>
  <button onclick="restartGame()">Neustart</button>
</div>
<script>
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const ui=document.getElementById('ui');
const upgradeMenu=document.getElementById('upgradeMenu');
const deathMenu=document.getElementById('deathMenu');
let keys={};
window.addEventListener('keydown',e=>keys[e.key]=true);
window.addEventListener('keyup',e=>keys[e.key]=false);
canvas.addEventListener('mousemove',e=>{
  let rect=canvas.getBoundingClientRect();
  player.angle=Math.atan2(e.clientY-rect.top-canvas.height/2,e.clientX-rect.left-canvas.width/2);
});

const world={x:0,y:0};
let gamePaused=false;
let gameTime=45*60;
let lastTime=0;
let autoShootTimer=0;

let player={
  x:canvas.width/2,
  y:canvas.height/2,
  size:20,
  speed:2,
  hp:100,
  maxHp:100,
  bullets:[],
  crystals:0,
  level:1,
  upgrades:[],
  dashCooldown:0,
  bees:[],
  fireballs:[],
  helpers:[]
};

let monsters=[];
let crystals=[];
let trees=[],rocks=[];

// Weltobjekte
for(let i=0;i<50;i++){trees.push({x:Math.random()*4000-2000,y:Math.random()*4000-2000,angle:Math.random()*Math.PI*2})}
for(let i=0;i<50;i++){rocks.push({x:Math.random()*4000-2000,y:Math.random()*4000-2000})}

// Monsterarten
const monsterTypes=[
{name:'Ork',hp:10,speed:1,color:'green'},
{name:'Drache',hp:50,speed:0.5,color:'red'},
{name:'Schlange',hp:15,speed:2,color:'purple'},
{name:'Hexe',hp:20,speed:1.5,color:'orange'},
{name:'Troll',hp:30,speed:0.8,color:'darkgreen'}
];

// Upgrades
let upgradesList=[
{name:"Bienen",desc:"Bienen attackieren Gegner",level:0,max:5,effect:["Kleine Bienen","Mehr Bienen","Größere Reichweite","Honigspuren","Bärenkönig"]},
{name:"Feuerball",desc:"Feuerball Schaden",level:0,max:5,effect:["Klein","Stärker","Explosiv","Flammenspur","Inferno"]},
{name:"Heilung",desc:"Heile automatisch",level:0,max:5,effect:["Leicht","Mehr","Heilkreis","Aura","Göttlich"]},
{name:"Blitz",desc:"Blitz trifft Gegner",level:0,max:5,effect:["Klein","Mehr","Kette","Feld","Donner"]},
{name:"Eis",desc:"Verlangsamt Gegner",level:0,max:5,effect:["Klein","Mehr","Feld","Sturm","König"]},
{name:"Doppelgänger",desc:"Hilft dir",level:0,max:5,effect:["Klein","Stark","Mehr","Armee","Meister"]}
];

function spawnMonster(){
  let type=monsterTypes[Math.floor(Math.random()*monsterTypes.length)];
  let x=(Math.random()*2000-1000)+world.x;
  let y=(Math.random()*2000-1000)+world.y;
  monsters.push({x,y,type:type.name,hp:type.hp,speed:type.speed,color:type.color,angle:0});
}

function spawnCrystal(x,y){
  let size=Math.random()>0.5?10:5;
  crystals.push({x,y,size,angle:Math.random()*Math.PI*2});
}

function pickUpUpgrade(){
  gamePaused=true;
  upgradeMenu.innerHTML="<div>Wähle ein Upgrade:</div>";
  let options=[];
  while(options.length<3){
    let u=upgradesList[Math.floor(Math.random()*upgradesList.length)];
    if(!options.includes(u)) options.push(u);
  }
  options.forEach(u=>{
    let btn=document.createElement('button');
    btn.innerText=u.name+" ("+u.effect[u.level]+")";
    btn.onclick=()=>{
      u.level++; player.upgrades.push(u.name);
      upgradeMenu.style.display="none"; gamePaused=false;
    }
    upgradeMenu.appendChild(btn);
  });
  upgradeMenu.style.display="flex";
}

function restartGame(){
  deathMenu.style.display="none";
  player.hp=player.maxHp;player.crystals=0;player.level=1;monsters=[];crystals=[];gameTime=45*60;world.x=0;world.y=0;
}

function update(dt){
  if(gamePaused) return;
  gameTime-=dt; if(gameTime<=0){gameTime=0;alert("Gewonnen!"); restartGame();}
  ui.innerText=Math.floor(gameTime/60).toString().padStart(2,"0")+":"+(Math.floor(gameTime%60).toString().padStart(2,"0"));

  // Dash
  if(keys[' ']){if(player.dashCooldown<=0){player.dashCooldown=1;world.x-=player.speed*20*Math.cos(player.angle);world.y-=player.speed*20*Math.sin(player.angle);}}
  if(player.dashCooldown>0) player.dashCooldown-=dt;

  // Bewegung
  let moveX=0,moveY=0;
  if(keys['w']) moveY=-1;if(keys['s']) moveY=1;if(keys['a']) moveX=-1;if(keys['d']) moveX=1;
  world.x-=moveX*player.speed; world.y-=moveY*player.speed;

  // AutoShoot
  autoShootTimer+=dt;
  if(autoShootTimer>=0.5){autoShootTimer=0;
    if(monsters.length>0){
      let target=monsters.reduce((a,b)=>Math.hypot(a.x-canvas.width/2,b.y-canvas.height/2)<Math.hypot(b.x-canvas.width/2,b.y-canvas.height/2)?a:b);
      let dx=target.x-canvas.width/2; let dy=target.y-canvas.height/2;
      player.bullets.push({x:canvas.width/2,y:canvas.height/2,dx:dx/Math.hypot(dx,dy)*5,dy:dy/Math.hypot(dx,dy)*5});
    }
  }

  // Bullets
  player.bullets.forEach(b=>{b.x+=b.dx;b.y+=b.dy;});
  player.bullets=player.bullets.filter(b=>b.x>0 && b.x<canvas.width && b.y>0 && b.y<canvas.height);

  // Monster Bewegung
  monsters.forEach(m=>{
    let dx=canvas.width/2-m.x; let dy=canvas.height/2-m.y; let dist=Math.hypot(dx,dy);
    m.angle=Math.atan2(dy,dx);
    m.x+=dx/dist*m.speed; m.y+=dy/dist*m.speed;
    if(dist<30){player.hp-=20*dt;if(player.hp<=0){deathMenu.style.display="flex";gamePaused=true;}}
  });

  // Bullets vs Monster
  player.bullets.forEach(b=>{
    monsters.forEach(m=>{
      let dx=b.x-m.x; let dy=b.y-m.y;
      if(Math.hypot(dx,dy)<15){m.hp--; b.hit=true; if(m.hp<=0){spawnCrystal(m.x,m.y);monsters=monsters.filter(x=>x!==m);player.crystals++; if(player.crystals%5==0) pickUpUpgrade();}} 
    });
  });
  player.bullets=player.bullets.filter(b=>!b.hit);

  // Monster spawn
  if(Math.random()<0.02) spawnMonster();

  // Upgrade Effekte
  // Beispiel: Bienen
  if(player.upgrades.includes("Bienen")){
    if(player.bees.length<5) player.bees.push({angle:Math.random()*Math.PI*2,r:30});
    player.bees.forEach(b=>{b.angle+=dt;});
  }
}

// Draw
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Welt
  ctx.save(); ctx.translate(world.x,world.y);
  trees.forEach(t=>{ctx.fillStyle="darkgreen"; ctx.fillRect(t.x-5,t.y-20,10,20)});
  rocks.forEach(r=>{ctx.fillStyle="grey"; ctx.fillRect(r.x-5,r.y-5,10,10)});
  crystals.forEach(c=>{ctx.fillStyle="cyan";ctx.beginPath();ctx.moveTo(c.x,c.y-c.size);ctx.lineTo(c.x+c.size,c.y);ctx.lineTo(c.x,c.y+c.size);ctx.lineTo(c.x-c.size,c.y);ctx.closePath();ctx.fill();});
  monsters.forEach(m=>{
    ctx.save();ctx.translate(m.x,m.y);ctx.rotate(Math.sin(performance.now()/200));ctx.fillStyle=m.color;
    ctx.beginPath();ctx.arc(0,0,20,0,Math.PI*2);ctx.fill();ctx.restore();
  });
  ctx.restore();

  // Spieler
  ctx.save(); ctx.translate(player.x,player.y); ctx.rotate(player.angle);
  ctx.fillStyle="blue"; ctx.beginPath(); ctx.moveTo(0,-20); ctx.lineTo(10,10); ctx.lineTo(-10,10); ctx.closePath(); ctx.fill();
  // Bienen
  if(player.bees) player.bees.forEach(b=>{ctx.beginPath();ctx.arc(Math.cos(b.angle)*b.r,Math.sin(b.angle)*b.r,5,0,Math.PI*2);ctx.fillStyle="yellow";ctx.fill();});
  ctx.restore();

  // HP Bar
  ctx.fillStyle="red"; ctx.fillRect(10,10,200,20);
  ctx.fillStyle="green"; ctx.fillRect(10,10,200*(player.hp/player.maxHp),20);

  // Bullets
  ctx.fillStyle="yellow"; player.bullets.forEach(b=>{ctx.beginPath();ctx.arc(b.x,b.y,5,0,Math.PI*2);ctx.fill();});
}

function gameLoop(ts){
  let dt=(ts-lastTime)/1000; lastTime=ts;
  update(dt); draw();
  requestAnimationFrame(gameLoop);
}
requestAnimationFrame(gameLoop);
</script>
</body>
</html>
