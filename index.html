<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>MadLand</title>
<style>
    html, body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #87CEEB;
    }
    canvas {
        display: block;
        background: #2ecc71;
    }
    #upgradeMenu {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.7);
        padding: 20px;
        border-radius: 15px;
        display: none;
        z-index: 1000;
        color: #fff;
        font-family: sans-serif;
    }
    .upgradeOption {
        margin: 10px;
        padding: 10px;
        background: rgba(255,255,255,0.2);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .upgradeOption:hover {
        background: rgba(255,255,255,0.4);
    }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="upgradeMenu"></div>
<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let width = window.innerWidth;
let height = window.innerHeight;
canvas.width = width;
canvas.height = height;

// --- Game Variables ---
let keys = {};
let player = {
    x: width/2, y: height/2, size: 40, color: 'blue', speed: 5, health: 100,
    dashCooldown: 0, dashSpeed: 15, dx:0, dy:0
};
let monsters = [];
let bullets = [];
let upgrades = [];
let activeUpgrades = [];
let crystals = [];
let timer = 45*60; // 45 min in seconds
let level = 1;
let xp = 0;
let xpToLevel = 5;
let showUpgradeMenu = false;
let gameOver = false;

// --- Controls ---
window.addEventListener('keydown', e => { keys[e.key.toLowerCase()] = true; });
window.addEventListener('keyup', e => { keys[e.key.toLowerCase()] = false; });

// --- Utility Functions ---
function randomInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function distance(a,b){ return Math.hypot(a.x-b.x,a.y-b.y); }

// --- Monsters ---
class Monster {
    constructor(type){
        this.type = type;
        this.size = type==='Dragon'?60: type==='Troll'?50: type==='Witch'?40:30;
        this.color = type==='Dragon'?'red':type==='Troll'?'brown':type==='Witch'?'purple':'green';
        this.x = randomInt(0,width*2)-width;
        this.y = randomInt(0,height*2)-height;
        this.health = this.size;
        this.speed = type==='Dragon'?2:type==='Troll'?1.5:type==='Witch'?1:2.5;
    }
    draw(){
        // simple body with healthbar
        ctx.fillStyle=this.color;
        ctx.beginPath();
        ctx.arc(this.x,this.y,this.size/2,0,Math.PI*2);
        ctx.fill();
        // Health bar
        ctx.fillStyle='red';
        ctx.fillRect(this.x-this.size/2,this.y-this.size/2-10,this.size,5);
        ctx.fillStyle='lime';
        ctx.fillRect(this.x-this.size/2,this.y-this.size/2-10,this.size*(this.health/(this.size)),5);
    }
    move(){
        let angle=Math.atan2(player.y-this.y,player.x-this.x);
        this.x+=Math.cos(angle)*this.speed;
        this.y+=Math.sin(angle)*this.speed;
    }
}

// --- Bullets ---
class Bullet {
    constructor(x,y,target){
        this.x=x;
        this.y=y;
        this.target=target;
        this.speed=10;
        this.size=8;
        this.color='yellow';
    }
    draw(){ ctx.fillStyle=this.color; ctx.beginPath(); ctx.arc(this.x,this.y,this.size,0,Math.PI*2); ctx.fill(); }
    move(){
        let angle=Math.atan2(this.target.y-this.y,this.target.x-this.x);
        this.x+=Math.cos(angle)*this.speed;
        this.y+=Math.sin(angle)*this.speed;
    }
}

// --- Crystals ---
class Crystal{
    constructor(x,y,size){
        this.x=x; this.y=y; this.size=size; this.color=size>7?'cyan':'lightblue';
    }
    draw(){ ctx.fillStyle=this.color; ctx.beginPath(); ctx.moveTo(this.x,this.y-this.size);
        for(let i=1;i<6;i++){ctx.lineTo(this.x+this.size*Math.sin(i*2*Math.PI/5),this.y-this.size*Math.cos(i*2*Math.PI/5));}
        ctx.fill(); ctx.closePath();}
}

// --- Upgrades ---
const allUpgrades = [
    {name:'Bienen',level:0,max:5,desc:'Kleine Bienen greifen Gegner an'},
    {name:'Heilung',level:0,max:5,desc:'Regeneriere Health über Zeit'},
    {name:'Feuerball',level:0,max:5,desc:'Schieße Feuerbälle'},
    {name:'Eis',level:0,max:5,desc:'Verlangsamt Gegner'},
    {name:'Blitz',level:0,max:5,desc:'Elektrische Angriffe'},
    {name:'Schutzschild',level:0,max:5,desc:'Reduziert Schaden'}
];

// --- Game Loop ---
function spawnMonster(){monsters.push(new Monster(['Dragon','Troll','Witch','Orc'][randomInt(0,3)]));}
function spawnCrystal(x,y){crystals.push(new Crystal(x,y,randomInt(5,12)));}

function handlePlayer(){
    let moveX=0, moveY=0;
    if(keys['w']) moveY=-player.speed;
    if(keys['s']) moveY=player.speed;
    if(keys['a']) moveX=-player.speed;
    if(keys['d']) moveX=player.speed;
    player.x+=moveX; player.y+=moveY;
    if(keys[' ']){
        if(player.dashCooldown<=0){
            player.x+=moveX*player.dashSpeed;
            player.y+=moveY*player.dashSpeed;
            player.dashCooldown=60; 
        }
    }
    if(player.dashCooldown>0) player.dashCooldown--;
    // draw player
    ctx.fillStyle='blue';
    ctx.beginPath();
    ctx.arc(player.x,player.y,player.size/2,0,Math.PI*2);
    ctx.fill();
    // Healthbar
    ctx.fillStyle='red';
    ctx.fillRect(20,20,200,20);
    ctx.fillStyle='lime';
    ctx.fillRect(20,20,200*(player.health/100),20);
}

function handleBullets(){
    bullets.forEach((b,i)=>{
        b.move();
        b.draw();
        monsters.forEach((m,j)=>{
            if(distance(b,m)<m.size/2){
                m.health-=10;
                bullets.splice(i,1);
                if(m.health<=0){
                    spawnCrystal(m.x,m.y);
                    monsters.splice(j,1);
                    xp++;
                    if(xp>=xpToLevel){showUpgradeScreen();}
                }
            }
        });
    });
}

function handleMonsters(){
    monsters.forEach(m=>{
        m.move();
        m.draw();
        if(distance(player,m)<player.size/2 + m.size/2){
            player.health-=0.5;
            if(player.health<=0) gameOver=true;
        }
    });
}

function handleCrystals(){
    crystals.forEach((c,i)=>{
        c.draw();
        if(distance(player,c)<player.size/2+c.size/2){
            xp++;
            crystals.splice(i,1);
            if(xp>=xpToLevel) showUpgradeScreen();
        }
    });
}

function shootAtNearest(){
    if(monsters.length>0){
        let target = monsters.reduce((a,b)=> distance(a,player)<distance(b,player)?a:b );
        bullets.push(new Bullet(player.x,player.y,target));
    }
}

// --- Upgrade Menu ---
const upgradeMenu = document.getElementById('upgradeMenu');
function showUpgradeScreen(){
    showUpgradeMenu=true;
    upgradeMenu.innerHTML='';
    let options=[];
    while(options.length<3){
        let u = allUpgrades[randomInt(0,allUpgrades.length-1)];
        if(!options.includes(u)) options.push(u);
    }
    options.forEach(u=>{
        let div=document.createElement('div');
        div.classList.add('upgradeOption');
        div.textContent=u.name + ' lvl ' + u.level + ' - ' + u.desc;
        div.onclick=()=>{
            u.level++; xp=0; showUpgradeMenu=false;
        };
        upgradeMenu.appendChild(div);
    });
    upgradeMenu.style.display='block';
}

// --- Game Loop ---
function gameLoop(){
    ctx.clearRect(0,0,width,height);
    // Timer
    ctx.fillStyle='black';
    ctx.font='40px sans-serif';
    ctx.fillText(`Time: ${Math.floor(timer/60)}:${('0'+timer%60).slice(-2)}`, width/2-80, 50);
    ctx.fillText(`Level: ${level}`, width-200,50);
    ctx.fillText(`XP: ${xp}/${xpToLevel}`, width/2-80,height-30);

    if(!showUpgradeMenu && !gameOver){
        timer--; if(timer<=0) gameOver=true;
        handlePlayer();
        if(frame%30===0) shootAtNearest();
        handleMonsters();
        handleBullets();
        handleCrystals();
        if(frame%120===0) spawnMonster();
    }
    requestAnimationFrame(gameLoop);
}

let frame=0;
function loop(){
    frame++;
    gameLoop();
}
loop();
</script>
</body>
</html>
